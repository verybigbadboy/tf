#cloud-config
bootcmd:
- "curl -fsSL https://dl.packager.io/srv/gogs/gogs/key | apt-key add -"
- 'sed -i "/preserve_hostname: false/c\preserve_hostname: true" /etc/cloud/cloud.cfg'
- hostnamectl set-hostname ${tf_hostname}
- for i in {1..10}; do dhclient; done
- for i in {1..10}; do dhclient -r; done
- systemctl daemon-reload && service systemd-networkd restart

hostname: ${tf_hostname}
fqdn: ${tf_hostname}.local
ssh_pwauth: True
chpasswd:
  list: |
     root:Bad123
  expire: False
apt:
  primary:
    - arches: [default]
      search:
        - https://mirror.yandex.ru/ubuntu/
        - http://archive.ubuntu.com

  sources:
    zabbix:
      source: "deb http://repo.zabbix.com/zabbix/4.4/ubuntu bionic main"
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        Version: GnuPG v1.4.10 (GNU/Linux)

        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
        ui+/5ZJHakC67t5OgbMas3Hz4Q==
        =HHRW
        -----END PGP PUBLIC KEY BLOCK-----
    gogs:
      source: "deb https://dl.packager.io/srv/deb/gogs/gogs/master/ubuntu 18.04 main"
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        Version: GnuPG v1
      
        mQENBFEo1AcBCADA7ufM3DrjWvcZ3ShTayCOMPeoLlRHaUpMM/+7ZM6C/lA3xdIZ
        PEE8SKd+8uhO+fv+UfQcUhBr8wd2QVSFqT6+2kV/comjLKqim/7GaskudRjqVfTA
        AzwPBAE4otJnnsbU+t1veo+rMLNsPyq8UG9sNhO3Jm49zLaVtIFOEAOJ3NI33Tse
        i64ybxOe4Qnby7VRVs94kngdwE2giO+U7nnupfeQGZfN26OibPiglwCvBsdt70he
        qKrMrs2VUydH/OwMbWMFEn+ehA2Z8IWHFcyv5a+V/DWhX41MEYBclAAPbzez+TPu
        PNtMNWfHUFTXafdO6P64Kki00SWqgJXLpwurABEBAAG0KnBrZ3IuaW8gKGh0dHA6
        Ly9wa2dyLmlvKSA8c3VwcG9ydEBwa2dyLmlvPokBOAQTAQIAIgUCUSjUBwIbAwYL
        CQgHAwIGFQgCCQoLBBYCAwECHgECF4AACgkQttWDzL0z7rjlGAgAsnLvoxeb7U71
        0/8P3Ik/YNkjCrXVTI4ZF+gEkKKLoObO2QfP+VkujrbarYUPhMvLPYmBI0zkge6O
        KHr+vIhVHj5u6SsuGWRNUUFigKFt8nQDVU4ts/IYyyrvc2pftJrLDeBiN53H0lwI
        y0ANxLz/1XSFCug6RQTewa8aCZi2Ek51YuPL8btIhLXcmqe+oOYhRIbZNeMoQfyn
        yeek2tUq4Mlp9XOn0o9w+N7E0FlZhVRJ4cWtzKKdmuEVtIIdzWcu6vGFCmXhrjoG
        eGpIdTYmXUYbV6bZ6nYZmresKcPOYjNKn97fTrGHV0rfBgEf8Nv9H7BP1cPbtXUq
        zcyU6/9QrA==
        =/EuB
        -----END PGP PUBLIC KEY BLOCK-----

package_update: true
package_upgrade: true
apt_update: true
apt_upgrade: true
packages:
  - qemu-guest-agent
  - mysql-client
  - nginx
  - gogs
  - zabbix-agent

disk_setup:
  /dev/vdb:
    table_type: mbr
    layout:
      - 100
    overwrite: False

fs_setup:
  - label: gogsdata
    filesystem: ext4
    device: /dev/vdb1
    overwrite: false

mounts:
  - [ /dev/vdb1, /gogs, auto, "defaults,noexec" ]

mount_default_fields: [ None, None, "auto", "defaults,nofail", "0", "2" ]

swap:
  filename: /swap.img
  size: "auto"
  maxsize: 2147483648


write_files:
  - owner: root:root
    path: /etc/nginx/sites-available/default
    content: |
      server {
        listen          80;
        server_name     ${tf_hostname};
        location / {
          proxy_pass      http://localhost:6000;
        }
      }

  - owner: root:root
    path: /gogs.sql
    content: |
      SET @s = IF(version() < 8 OR version() LIKE '%MariaDB%', 
            'SET GLOBAL innodb_file_per_table = ON, 
                        innodb_file_format = Barracuda, 
                        innodb_large_prefix = ON;', 
            'SET GLOBAL innodb_file_per_table = ON;');
      PREPARE stmt1 FROM @s;
      EXECUTE stmt1; 

      CREATE DATABASE IF NOT EXISTS gogs CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
      CREATE USER 'gogs'@'%' IDENTIFIED BY 'GogsPasswordIsComplex123';
      GRANT ALL ON gogs.* TO gogs@'%';
      flush privileges;

  - owner: root:root
    path: /etc/gogs/conf/app.ini
    content: |
      APP_NAME = Gogs
      RUN_USER = gogs
      RUN_MODE = prod

      [server]
      DOMAIN           = ${tf_hostname}.local
      ROOT_URL         = http://${tf_hostname}.local/
      DISABLE_SSH      = false
      START_SSH_SERVER = false
      OFFLINE_MODE     = true
      HTTP_PORT        = 6000
      SSH_PORT         = 22

      [repository]
      ROOT = /gogs

      [database]
      DB_TYPE  = mysql
      HOST     = mysql.local:3306
      NAME     = gogs
      USER     = gogs
      PASSWD   = GogsPasswordIsComplex123
      SSL_MODE = disable
      PATH     = data/gogs.db

      [service]
      REGISTER_EMAIL_CONFIRM                 = false
      DISABLE_REGISTRATION                   = false
      REQUIRE_SIGNIN_VIEW                    = false
      ENABLE_NOTIFY_MAIL                     = false
      ENABLE_REVERSE_PROXY_AUTHENTICATION    = false
      ENABLE_REVERSE_PROXY_AUTO_REGISTRATION = false
      ENABLE_CAPTCHA                         = true

      [picture]
      DISABLE_GRAVATAR        = true
      ENABLE_FEDERATED_AVATAR = false

      [security]
      INSTALL_LOCK = true
      SECRET_KEY   = OcLH9C8kGok1D8I

      [mailer]
      ENABLED = false

      [session]
      PROVIDER = file

      [log]
      MODE      = file
      LEVEL     = Info
      ROOT_PATH = /opt/gogs/log

  - owner: root:root
    path: /etc/zabbix/zabbix_agentd.d/server.conf
    permissions: '0644'
    content: |
      Server=zabbix.local
      ServerActive=zabbix.local
      HostMetadata=LINUX server
      Hostname=${tf_hostname}.local

runcmd:
  - service nginx restart
  - until nc -vzw 2 mysql.local 3306; do sleep 2; done
  - mysql -h mysql.local -uroot -pBad123 < /gogs.sql
  - mount /gogs || true
  - chown -R gogs:gogs /gogs
  - chown -R gogs:gogs /etc/gogs
  - serivce gogs restart && sleep 10
  - su gogs -c "/opt/gogs/gogs admin create-user --name=bad --password=Bad123 --email=verybigbadboy@gmail.com --admin=true --config /etc/gogs/conf/app.ini" || true
  - systemctl enable zabbix-agent.service

power_state:
  delay: "+1"
  mode: reboot
  message: Reboot from Cloud Init
  timeout: 5
